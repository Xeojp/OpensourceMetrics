#!/bin/bash
# OpenSourceMetrics - –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –º–µ—Ç—Ä–∏–∫ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç GitHub API. –¢—Ä–µ–±—É–µ—Ç: jq, git
# –ó–∞–ø—É—Å–∫: ./metrics.sh <username>/<repo>

set -e

if [ $# -ne 1 ]; then
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 <username/repo>"
    exit 1
fi

REPO="$1"
BASE_URL="https://api.github.com/repos/$REPO"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

header() {
    clear
    echo -e "${CYAN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${CYAN}‚ïë${NC} ${PURPLE}üìä METRICS –ê–ù–ê–õ–ò–ó–ê –û–¢–ö–†–´–¢–û–ì–û –ü–†–û–ï–ö–¢–ê${NC} ${CYAN}‚ïë${NC}"
    echo -e "${CYAN}‚ïë${NC} ${BLUE}$REPO${NC}                                        ${CYAN}‚ïë${NC}"
    echo -e "${CYAN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo
}

loading() {
    echo -e "${YELLOW}üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ $1...${NC}"
}

progress_bar() {
    local duration=${1}
    local bar_length=40
    local ticks=20
    
    for i in $(seq 1 $ticks); do
        local percent=$((i * 100 / ticks))
        local filled=$((i * bar_length / ticks))
        local spaces=$((bar_length - filled))
        
        printf "\r${GREEN}[%s%s] %d%%${NC}" \
            "$(printf '%*s' "$filled" '' | tr ' ' '‚ñà')" \
            "$(printf '%*s' "$spaces")" "$percent"
        
        sleep $((duration / ticks))
    done
    echo
}

print_section() {
    echo -e "${BLUE}‚îå‚îÄ $1 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê${NC}"
}

print_kv() {
    printf "${BLUE}‚îÇ${NC} ${GREEN}%-35s${NC} ${YELLOW}%s${NC}\n" "$1:" "$2"
}

print_kv_num() {
    printf "${BLUE}‚îÇ${NC} ${GREEN}%-35s${NC} ${PURPLE}%10s${NC} ${YELLOW}%s${NC}\n" "$1:" "$2" "$3"
}

footer() {
    echo -e "${BLUE}‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò${NC}\n"
}

header

loading "–æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏"
progress_bar 2

INFO=$(curl -s "https://api.github.com/repos/$REPO" | jq .)
if [ "$INFO" = "null" ]; then
    echo -e "${RED}‚ùå –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω!${NC}"
    exit 1
fi

print_section "–†–ï–ü–û–ó–ò–¢–û–†–ò–ô"
print_kv "–ù–∞–∑–≤–∞–Ω–∏–µ" "$(echo "$INFO" | jq -r '.name')"
print_kv "–û–ø–∏—Å–∞–Ω–∏–µ" "$(echo "$INFO" | jq -r '.description // "–Ω–µ—Ç"')"
print_kv_num "–ó–≤—ë–∑–¥—ã" "$(echo "$INFO" | jq -r '.stargazers_count')" ""
print_kv_num "–§–æ—Ä–∫–∏" "$(echo "$INFO" | jq -r '.forks_count')" ""
print_kv_num "Watchers" "$(echo "$INFO" | jq -r '.subscribers_count')" ""
print_kv "URL" "$(echo "$INFO" | jq -r '.html_url')"
footer

loading "—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏"
progress_bar 2

STATS=$(curl -s "$BASE_URL/stats/participation" | jq .)
COMMITS=$(curl -s "$BASE_URL/stats/commit_activity" | jq 'map(.total) | add')

print_section "–ê–ö–¢–ò–í–ù–û–°–¢–¨"
print_kv_num "–í—Å–µ–≥–æ –∫–æ–º–º–∏—Ç–æ–≤ (30 –¥–Ω–µ–π)" "$(echo "$COMMITS" | jq .)" ""
print_kv_num "–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–≤—Å–µ–≥–æ)" "$(echo "$INFO" | jq -r '.contributors_url | length')" ""
print_kv_num "–ö–æ–º–º–∏—Ç–æ–≤ –Ω–∞ —É—á–∞—Å—Ç–Ω–∏–∫–∞" "$(echo "scale=1; $(echo "$COMMITS" | jq .) / ($(echo "$INFO" | jq -r '.contributors_url | length') + 1)" | bc -l)" "avg"
footer

loading "issues –∏ pull requests"
progress_bar 2

ISSUES=$(curl -s "$BASE_URL/issues?state=all&per_page=1" | jq 'length')
OPEN_ISSUES=$(curl -s "$BASE_URL/issues?state=open&per_page=1" | jq 'length')
CLOSED_ISSUES=$(curl -s "$BASE_URL/issues?state=closed&per_page=1" | jq 'length')

print_section "ISSUES & PULL REQUESTS"
print_kv_num "–í—Å–µ–≥–æ Issues" "$ISSUES" ""
print_kv_num "–û—Ç–∫—Ä—ã—Ç—ã–µ" "$OPEN_ISSUES" ""
print_kv_num "–ó–∞–∫—Ä—ã—Ç—ã–µ" "$CLOSED_ISSUES" ""
print_kv_num "–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç—ã—Ö" "$(echo "scale=1; $CLOSED_ISSUES * 100 / ($ISSUES + 1)" | bc -l)" "%"
footer

loading "–∫–æ–Ω—Ç—Ä–∏–±—å—é—Ç–æ—Ä–æ–≤"
progress_bar 2

CONTRIBS=$(curl -s "$BASE_URL/contributors?per_page=5" | jq '.[].contributions')

print_section "–¢–û–ü –ö–û–ù–¢–†–ò–ë–¨–Æ–¢–û–†–´ (5)"
echo "$CONTRIBS" | jq -r '.[]' | nl -w2 -s' ' | while read num commits; do
    print_kv_num "$num" "$commits" "–∫–æ–º–º–∏—Ç–æ–≤"
done
footer

loading "–∞–Ω–∞–ª–∏–∑–∞ –∫–æ–¥–∞"
progress_bar 1

CLONE=$(curl -s "$BASE_URL" | jq -r '.clone_url')
git clone --depth 1 "$CLONE" /tmp/repo 2>/dev/null || true
LOC=$(find /tmp/repo -name "*.js" -o -name "*.ts" -o -name "*.py" -o -name "*.go" -o -name "*.rs" | xargs wc -l 2>/dev/null | tail -1 | awk '{print $1}')

print_section "–ö–ê–ß–ï–°–¢–í–û –ö–û–î–ê"
print_kv_num "–°—Ç—Ä–æ–∫ –∫–æ–¥–∞ (–ø—Ä–∏–º–µ—Ä–Ω–æ)" "${LOC:-"N/A"}" ""
print_kv "–§–∞–π–ª–æ–≤" "$(find /tmp/repo -type f | wc -l 2>/dev/null || echo "N/A")"
print_kv "–õ–∏—Ü–µ–Ω–∑–∏—è" "$(echo "$INFO" | jq -r '.license?.name // "–Ω–µ—Ç"')"
rm -rf /tmp/repo
footer

echo -e "${GREEN}–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω! –°–ø–∞—Å–∏–±–æ –∑–∞ —Ç–æ, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ —É—Ç–∏–ª–∏—Ç—É :)${NC}"
echo -e "${CYAN}–ú–µ—Ç—Ä–∏–∫–∏ –æ—Å–Ω–æ–≤–∞–Ω—ã –Ω–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è—Ö opensource.guide${NC}[web:7]"
echo
echo -e "${PURPLE}–ü—Ä–æ–µ–∫—Ç –∂–∏–≤, –µ—Å–ª–∏:${NC}"
echo -e "   ‚Ä¢ ${GREEN}>10${NC} –∑–≤—ë–∑–¥ –≤ –Ω–µ–¥–µ–ª—é"
echo -e "   ‚Ä¢ ${GREEN}>70%${NC} issues –∑–∞–∫—Ä—ã—Ç–æ"  
echo -e "   ‚Ä¢ ${GREEN}>2${NC} –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω—Ç—Ä–∏–±—å—é—Ç–æ—Ä–∞"
